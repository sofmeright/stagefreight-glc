create-release:
  stage: release
  image: alpine:3.22.1
  needs: [generate_release_notes]
  only:
    - tags
  before_script:
    - apk add --no-cache bash curl jq
  script:
    - RELEASE_NOTES=$(cat release.md)
    - >
      curl --fail --silent --header "PRIVATE-TOKEN: $GITLAB_TOKEN" --request POST
      --form "name=Release $CI_COMMIT_TAG"
      --form "tag_name=$CI_COMMIT_TAG"
      --form "description=$RELEASE_NOTES"
      "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases" || echo "Release might already exist"
    - COMPONENT_NAME="ansible"
    - CATALOG_LINK="$[[ inputs.gitlab_domain ]]/explore/catalog/components/$COMPONENT_NAME"
    - >
      curl --silent --fail --header "PRIVATE-TOKEN: $GITLAB_TOKEN"
      --request POST --header "Content-Type: application/json"
      --data "{\"name\":\"Ansible Component in GitLab Catalog\",\"url\":\"$CATALOG_LINK\",\"link_type\":\"other\"}"
      "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases/$CI_COMMIT_TAG/assets/links"