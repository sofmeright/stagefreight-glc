generate_readme_component_inputs:
  stage: release
  image: alpine:3.22.1
  only: [tags]
  variables:
    YQ_VERSION: "v4.44.1"
    YQ_BINARY: "yq_linux_amd64"
  before_script:
    - apk add --no-cache curl jq bash coreutils
    - curl -Ls "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/${YQ_BINARY}" -o /usr/bin/yq
    - chmod +x /usr/bin/yq
  script:
    - mkdir -p artifacts
    - yq '.spec.inputs' "$[[ inputs.component_spec_file ]]" > artifacts/_inputs_raw.yaml
    - sed -i '/^---$/,$d' artifacts/_inputs_raw.yaml
    - chmod +x scripts/component-inputs-syntax.sh
    - ./scripts/component-inputs-syntax.sh artifacts/_inputs_raw.yaml "$[[ inputs.output_md_file ]]"
    - >
      awk -v start="<!-- START_C_INPUTS_MAP -->" -v end="<!-- END_C_INPUTS_MAP -->" -v content="$(sed 's/\\/\\\\/g; s/"/\\"/g' $[[ inputs.output_md_file ]] | awk '{ print "echo \"" $0 "\"" }')" '
        BEGIN {inblock=0}
        $0 ~ start { print; system(content); inblock=1; next }
        $0 ~ end { inblock=0 }
        !inblock { print }
      ' "$[[ inputs.readme_file ]]" > updated_readme.md
    - CONTENT_BASE64=$(base64 -w 0 updated_readme.md)
    - ENCODED_FILE_PATH=$(printf '%s' "$[[ inputs.readme_file ]]" | jq -s -R -r @uri)
    - >
      curl --request PUT --header "PRIVATE-TOKEN: $GITLAB_TOKEN"
        --header "Content-Type: application/json"
        --data "{
          \"branch\": \"$[[ inputs.branch_name ]]\",
          \"content\": \"$CONTENT_BASE64\",
          \"commit_message\": \"Update component input map for $CI_COMMIT_TAG\",
          \"encoding\": \"base64\"
        }"
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/repository/files/$ENCODED_FILE_PATH"
  artifacts:
    paths: ["$[[ inputs.output_md_file ]]"]